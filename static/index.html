<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranger Finance Raise Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-red: #DC2626;
            --dark-red: #991B1B;
            --light-red: #FEE2E2;
            --accent-red: #EF4444;
            --white: #FFFFFF;
            --off-white: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-600: #4B5563;
            --gray-800: #1F2937;
            --green: #10B981;
            --yellow: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--off-white);
            color: var(--gray-800);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-red);
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: var(--white);
            border-left: none;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card.highlight .stat-value {
            font-size: 2rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 1rem;
            background: var(--primary-red);
            border-radius: 2px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .threshold-table {
            width: 100%;
            border-collapse: collapse;
        }

        .threshold-table th,
        .threshold-table td {
            padding: 0.6rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
        }

        .threshold-table th {
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .threshold-table tr:hover {
            background: var(--gray-100);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-yes {
            background: #DCFCE7;
            color: #166534;
        }

        .badge-no {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge-fair {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .prob-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .prob-bar-fill {
            height: 100%;
            background: var(--primary-red);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .prob-bar-fill.polymarket {
            background: #6366F1;
        }

        .projections-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .projection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: 8px;
        }

        .projection-name {
            font-weight: 500;
        }

        .projection-value {
            font-weight: 700;
            color: var(--primary-red);
        }

        .projection-mult {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .countdown {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .countdown-item {
            text-align: center;
        }

        .countdown-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .countdown-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .refresh-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--gray-600);
        }

        .legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-dot.model {
            background: var(--primary-red);
        }

        .legend-dot.polymarket {
            background: #6366F1;
        }

        .value-highlight {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .config-btn {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .config-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header {
            position: relative;
        }

        .config-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .config-panel.active {
            display: flex;
        }

        .config-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .config-content h3 {
            margin-bottom: 1.5rem;
            color: var(--gray-800);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-800);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--gray-600);
            font-size: 0.75rem;
        }

        .config-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-red);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-red);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .config-presets {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .config-presets h4 {
            margin-bottom: 1rem;
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .preset-btn {
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: var(--light-red);
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .current-config {
            background: var(--gray-100);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-left: 1rem;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-config .wallet-short {
            font-family: monospace;
            background: var(--gray-200);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="sale-title">MetaDAO Raise Tracker</h1>
        <p class="subtitle">Live MetaDAO Public Sale Analysis</p>
        <button class="config-btn" onclick="toggleConfig()">Configure Sale</button>
    </div>

    <div class="config-panel" id="config-panel">
        <div class="config-content">
            <h3>Configure Sale Tracking</h3>
            <div class="config-form">
                <div class="form-group">
                    <label for="sale-name">Sale Name</label>
                    <input type="text" id="sale-name" placeholder="e.g., Ranger Finance">
                </div>
                <div class="form-group">
                    <label for="wallet-input">Solscan Link or Wallet Address</label>
                    <input type="text" id="wallet-input" placeholder="https://solscan.io/account/... or wallet address">
                    <small>Paste a Solscan account URL or the raw Solana wallet address</small>
                </div>
                <div class="form-group">
                    <label for="end-time">Sale End Time (UTC)</label>
                    <input type="datetime-local" id="end-time">
                </div>
                <div class="form-group">
                    <label for="polymarket-slug">Polymarket Event Slug (optional)</label>
                    <input type="text" id="polymarket-slug" placeholder="e.g., total-commitments-for-the-ranger-public-sale-on-metadao">
                    <small>The slug from the Polymarket event URL</small>
                </div>
                <div class="config-buttons">
                    <button class="btn btn-primary" onclick="saveConfig()">Save & Track</button>
                    <button class="btn btn-secondary" onclick="resetConfig()">Reset to Default</button>
                    <button class="btn btn-secondary" onclick="toggleConfig()">Cancel</button>
                </div>
            </div>
            <div class="config-presets">
                <h4>Quick Presets (Historical Sales)</h4>
                <div class="preset-list">
                    <button class="preset-btn" onclick="loadPreset('ranger')">Ranger Finance</button>
                    <button class="preset-btn" onclick="loadPreset('solomon')">Solomon</button>
                    <button class="preset-btn" onclick="loadPreset('umbra')">Umbra</button>
                    <button class="preset-btn" onclick="loadPreset('loyal')">Loyal</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Current Raised</div>
                <div class="stat-value" id="balance">Loading...</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Projected Final</div>
                <div class="stat-value" id="combined-projection">--</div>
                <div class="stat-range" id="projection-range-confidence" style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Confidence Score</div>
                <div class="stat-value" id="confidence-score">--</div>
                <div id="confidence-level" style="font-size: 0.75rem; margin-top: 0.25rem;">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Time Remaining</div>
                <div class="stat-value" id="time-remaining">--:--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="tx-count">--</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-title">Historical Comparison at Current Timestamp</div>
            <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                Comparing Ranger's current raise to where other MetaDAO sales were at this same point before their end
            </div>
            <div class="chart-container" style="height: 280px;">
                <canvas id="historicalComparisonChart"></canvas>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-title">Hourly Activity</div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Projections by Pattern (Recency Weighted)</div>
                <div style="font-size: 0.7rem; color: var(--gray-600); margin-bottom: 0.75rem;">
                    Newer sales weighted higher: Solomon (35%) → Paystream (25%) → zkSOL (17%) → Loyal (12%) → Avici (7%) → Umbra (4%)
                </div>
                <div class="projections-list" id="projections-list">
                    <div class="loading">Loading projections...</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-title">Probability Comparison: Model vs Polymarket</div>
            <div class="chart-container" style="height: 300px;">
                <canvas id="probChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot model"></div> Model Estimate</div>
                <div class="legend-item"><div class="legend-dot polymarket"></div> Polymarket Odds</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Value Opportunities</div>
            <table class="threshold-table">
                <thead>
                    <tr>
                        <th>Threshold</th>
                        <th>Model</th>
                        <th style="width: 120px;">Model Bar</th>
                        <th>Polymarket</th>
                        <th style="width: 120px;">PM Bar</th>
                        <th>Difference</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody id="opportunities-table">
                    <tr><td colspan="7" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="refresh-indicator" id="refresh-indicator">
        Refreshing in <span id="refresh-countdown">30</span>s
    </div>

    <script>
        let activityChart = null;
        let probChart = null;
        let historicalChart = null;
        let refreshInterval = 30;
        let countdownValue = refreshInterval;

        // Default configuration
        const DEFAULT_CONFIG = {
            saleName: 'Ranger Finance',
            wallet: '9ApaAe39Z8GEXfqm7F7HL545N4J4tN7RhF8FhS88pRNp',
            endTime: '2026-01-10T16:00:00Z',
            polymarketSlug: 'total-commitments-for-the-ranger-public-sale-on-metadao'
        };

        // Preset configurations for historical sales
        const PRESETS = {
            ranger: {
                saleName: 'Ranger Finance',
                wallet: '9ApaAe39Z8GEXfqm7F7HL545N4J4tN7RhF8FhS88pRNp',
                endTime: '2026-01-10T16:00:00Z',
                polymarketSlug: 'total-commitments-for-the-ranger-public-sale-on-metadao'
            },
            solomon: {
                saleName: 'Solomon',
                wallet: 'So1endDq2YkqhipRh3WViPa8hdiSpxWy6z3Z6tF4JmR',
                endTime: '2025-11-18T16:00:00Z',
                polymarketSlug: ''
            },
            umbra: {
                saleName: 'Umbra',
                wallet: 'UMBRAwPbQqbrEGPK9hKsJhKEuYRBpHbJm9B3bqK4p8E',
                endTime: '2025-10-10T16:00:00Z',
                polymarketSlug: ''
            },
            loyal: {
                saleName: 'Loyal',
                wallet: 'LoYALTYC8zZoHKRNtNQJiMGxXKrJ7sS7SntKvQTuvLy',
                endTime: '2025-10-22T16:00:00Z',
                polymarketSlug: ''
            }
        };

        // Current configuration
        let currentConfig = { ...DEFAULT_CONFIG };

        function loadConfig() {
            const saved = localStorage.getItem('metadao-tracker-config');
            if (saved) {
                try {
                    currentConfig = JSON.parse(saved);
                } catch (e) {
                    currentConfig = { ...DEFAULT_CONFIG };
                }
            }
            updateUIFromConfig();
        }

        function saveConfig() {
            const walletInput = document.getElementById('wallet-input').value.trim();
            const saleName = document.getElementById('sale-name').value.trim();
            const endTime = document.getElementById('end-time').value;
            const polymarketSlug = document.getElementById('polymarket-slug').value.trim();

            // Parse wallet from Solscan link or use as-is
            let wallet = walletInput;
            const solscanMatch = walletInput.match(/solscan\.io\/account\/([A-Za-z0-9]{32,44})/);
            if (solscanMatch) {
                wallet = solscanMatch[1];
            }

            if (!wallet || wallet.length < 32) {
                alert('Please enter a valid Solana wallet address or Solscan link');
                return;
            }

            if (!endTime) {
                alert('Please set a sale end time');
                return;
            }

            currentConfig = {
                saleName: saleName || 'MetaDAO Sale',
                wallet: wallet,
                endTime: new Date(endTime).toISOString(),
                polymarketSlug: polymarketSlug
            };

            localStorage.setItem('metadao-tracker-config', JSON.stringify(currentConfig));
            updateUIFromConfig();
            toggleConfig();

            // Reset charts and fetch new data
            if (activityChart) activityChart.destroy();
            if (probChart) probChart.destroy();
            if (historicalChart) historicalChart.destroy();
            activityChart = null;
            probChart = null;
            historicalChart = null;

            fetchData();
        }

        function resetConfig() {
            localStorage.removeItem('metadao-tracker-config');
            currentConfig = { ...DEFAULT_CONFIG };
            updateUIFromConfig();
            populateConfigForm();
        }

        function loadPreset(presetName) {
            const preset = PRESETS[presetName];
            if (preset) {
                document.getElementById('sale-name').value = preset.saleName;
                document.getElementById('wallet-input').value = preset.wallet;
                document.getElementById('polymarket-slug').value = preset.polymarketSlug || '';

                // Format datetime-local value
                const dt = new Date(preset.endTime);
                const localDt = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000);
                document.getElementById('end-time').value = localDt.toISOString().slice(0, 16);
            }
        }

        function updateUIFromConfig() {
            document.getElementById('sale-title').textContent = currentConfig.saleName + ' Raise Tracker';
            document.title = currentConfig.saleName + ' Raise Tracker';
        }

        function populateConfigForm() {
            document.getElementById('sale-name').value = currentConfig.saleName;
            document.getElementById('wallet-input').value = currentConfig.wallet;
            document.getElementById('polymarket-slug').value = currentConfig.polymarketSlug || '';

            // Format datetime-local value
            const dt = new Date(currentConfig.endTime);
            const localDt = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000);
            document.getElementById('end-time').value = localDt.toISOString().slice(0, 16);
        }

        function toggleConfig() {
            const panel = document.getElementById('config-panel');
            const isActive = panel.classList.contains('active');

            if (!isActive) {
                populateConfigForm();
            }

            panel.classList.toggle('active');
        }

        function parseWalletFromInput(input) {
            // Try to extract wallet from Solscan URL
            const solscanMatch = input.match(/solscan\.io\/account\/([A-Za-z0-9]{32,44})/);
            if (solscanMatch) {
                return solscanMatch[1];
            }
            // Otherwise assume it's a raw wallet address
            return input.trim();
        }

        function formatCurrency(value) {
            if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            }
            return '$' + value.toLocaleString();
        }

        function formatTime(hours) {
            const h = Math.floor(hours);
            const m = Math.floor((hours - h) * 60);
            return `${h}h ${m}m`;
        }

        function updateDashboard(data) {
            // Update stats
            document.getElementById('balance').textContent = formatCurrency(data.balance);
            document.getElementById('time-remaining').textContent = formatTime(data.hours_remaining);
            document.getElementById('tx-count').textContent = data.transactions.toLocaleString();

            // Combined projection
            if (data.combined_projection) {
                document.getElementById('combined-projection').textContent = formatCurrency(data.combined_projection);
            }

            // Confidence score
            if (data.confidence) {
                document.getElementById('confidence-score').textContent = data.confidence.score + '%';
                const levelEl = document.getElementById('confidence-level');
                const levelColors = { 'HIGH': '#10B981', 'MEDIUM': '#F59E0B', 'LOW': '#EF4444' };
                levelEl.innerHTML = `<span style="color: ${levelColors[data.confidence.level] || '#6B7280'}">${data.confidence.level}</span>`;

                // Confidence range
                document.getElementById('projection-range-confidence').textContent =
                    `Range: ${formatCurrency(data.confidence.range_low)} - ${formatCurrency(data.confidence.range_high)}`;
            }

            // Update refresh rate dynamically
            if (data.refresh_rate && data.refresh_rate !== refreshInterval) {
                refreshInterval = data.refresh_rate;
                countdownValue = Math.min(countdownValue, refreshInterval);
            }

            // Historical comparison chart
            if (data.historical_snapshots) {
                updateHistoricalComparisonChart(data.historical_snapshots, data.balance);
            }

            // Projection range
            const projections = data.projections;
            const minProj = projections[0].projected;
            const maxProj = projections[projections.length - 1].projected;

            // Update projections list - sorted by recency weight (highest first)
            const projList = document.getElementById('projections-list');
            const sortedByWeight = [...projections].sort((a, b) => b.weight - a.weight);
            projList.innerHTML = sortedByWeight.map(p => `
                <div class="projection-item" style="border-left: 3px solid ${p.weight >= 0.25 ? '#DC2626' : p.weight >= 0.10 ? '#F59E0B' : '#9CA3AF'};">
                    <div>
                        <div class="projection-name">${p.name} <span style="font-size: 0.7rem; color: var(--gray-600);">(${p.sale_date})</span></div>
                        <div class="projection-mult">${p.multiplier}x mult • <strong style="color: ${p.weight >= 0.25 ? '#DC2626' : 'inherit'};">${(p.weight * 100).toFixed(0)}% weight</strong> • Raised $${(p.final_raised/1000000).toFixed(0)}M</div>
                    </div>
                    <div class="projection-value">${formatCurrency(p.projected)}</div>
                </div>
            `).join('');

            // Update activity chart
            updateActivityChart(data.hourly_activity);

            // Update probability chart
            updateProbChart(data.model_probabilities, data.polymarket_odds);

            // Update opportunities table
            updateOpportunitiesTable(data.model_probabilities, data.polymarket_odds, data.opportunities);
        }

        function updateHistoricalComparisonChart(snapshots, currentBalance) {
            const ctx = document.getElementById('historicalComparisonChart').getContext('2d');

            // Prepare data - add Ranger as the first bar
            const labels = ['RANGER (now)', ...snapshots.map(s => s.name)];
            const amounts = [currentBalance, ...snapshots.map(s => s.amount)];
            const finals = [null, ...snapshots.map(s => s.final)];

            // Color Ranger differently
            const colors = amounts.map((_, i) => i === 0 ? '#DC2626' : '#6B7280');

            if (historicalChart) {
                historicalChart.data.labels = labels;
                historicalChart.data.datasets[0].data = amounts;
                historicalChart.data.datasets[0].backgroundColor = colors;
                historicalChart.data.datasets[1].data = finals;
                historicalChart.update();
            } else {
                historicalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'At Current Time',
                                data: amounts,
                                backgroundColor: colors,
                                borderRadius: 4,
                            },
                            {
                                label: 'Final Raise',
                                data: finals,
                                backgroundColor: 'rgba(99, 102, 241, 0.3)',
                                borderColor: '#6366F1',
                                borderWidth: 2,
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        if (value === null) return '';
                                        return context.dataset.label + ': $' + (value / 1e6).toFixed(1) + 'M';
                                    },
                                    afterLabel: function(context) {
                                        if (context.datasetIndex === 0 && context.dataIndex > 0) {
                                            const snapshot = snapshots[context.dataIndex - 1];
                                            return `(${snapshot.pct_of_final}% of final)`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: v => '$' + (v / 1e6).toFixed(0) + 'M'
                                }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function updateActivityChart(hourlyData) {
            const ctx = document.getElementById('activityChart').getContext('2d');

            const labels = hourlyData.map(d => d.hour);
            const values = hourlyData.map(d => d.transactions);

            if (activityChart) {
                activityChart.data.labels = labels;
                activityChart.data.datasets[0].data = values;
                activityChart.update();
            } else {
                activityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Transactions',
                            data: values,
                            backgroundColor: '#DC2626',
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        function updateProbChart(modelProbs, polymarketOdds) {
            const canvas = document.getElementById('probChart');
            const ctx = canvas.getContext('2d');

            const thresholds = [20, 30, 40, 50, 60, 70, 80, 90, 100];
            const labels = thresholds.map(t => `>$${t}M`);

            // Handle both number and string keys from JSON
            const modelData = thresholds.map(t => {
                const val = modelProbs[t] !== undefined ? modelProbs[t] : modelProbs[String(t)];
                return val !== undefined ? val : 0;
            });
            const pmData = thresholds.map(t => {
                const val = polymarketOdds[t] !== undefined ? polymarketOdds[t] : polymarketOdds[String(t)];
                return val !== undefined ? val : 0;
            });

            console.log('Model data:', modelData);
            console.log('Polymarket data:', pmData);
            console.log('Raw polymarket odds:', polymarketOdds);

            // Destroy existing chart to ensure clean render
            if (probChart) {
                probChart.destroy();
            }

            probChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Model Estimate',
                            data: modelData,
                            backgroundColor: '#DC2626',
                            borderRadius: 4,
                        },
                        {
                            label: 'Polymarket',
                            data: pmData,
                            backgroundColor: '#6366F1',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateOpportunitiesTable(modelProbs, polymarketOdds, opportunities) {
            const tbody = document.getElementById('opportunities-table');
            const thresholds = [15, 20, 30, 40, 50, 60, 70, 80, 90, 100, 120, 140, 160, 180, 200];

            tbody.innerHTML = thresholds.map(t => {
                const model = modelProbs[t] ?? modelProbs[String(t)] ?? 0;
                const pm = polymarketOdds[t] ?? polymarketOdds[String(t)] ?? 0;
                const diff = model - pm;
                const opp = opportunities[t] || { action: 'FAIR', edge: 0 };

                let badgeClass = 'badge-fair';
                let signal = 'FAIR';
                if (opp.action === 'BUY YES') {
                    badgeClass = 'badge-yes';
                    signal = `YES +${opp.edge}%`;
                } else if (opp.action === 'BUY NO') {
                    badgeClass = 'badge-no';
                    signal = `NO +${opp.edge}%`;
                }

                const isValue = Math.abs(diff) >= 10;

                return `
                    <tr class="${isValue ? 'value-highlight' : ''}">
                        <td><strong>>$${t}M</strong></td>
                        <td>${model.toFixed(0)}%</td>
                        <td><div class="prob-bar"><div class="prob-bar-fill" style="width: ${model}%"></div></div></td>
                        <td>${pm.toFixed(0)}%</td>
                        <td><div class="prob-bar"><div class="prob-bar-fill polymarket" style="width: ${pm}%"></div></div></td>
                        <td style="color: ${diff > 0 ? '#10B981' : diff < 0 ? '#DC2626' : 'inherit'}">
                            ${diff > 0 ? '+' : ''}${diff.toFixed(0)}%
                        </td>
                        <td><span class="badge ${badgeClass}">${signal}</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function fetchData() {
            try {
                // Build API URL with configuration parameters
                const params = new URLSearchParams({
                    wallet: currentConfig.wallet,
                    endTime: currentConfig.endTime,
                    polymarketSlug: currentConfig.polymarketSlug || ''
                });

                const response = await fetch(`/api/data?${params}`);
                const data = await response.json();

                if (data.error) {
                    console.error('API Error:', data.error);
                    document.getElementById('balance').textContent = 'Error loading data';
                    return;
                }

                updateDashboard(data);

                if (data.sale_ended) {
                    document.getElementById('refresh-indicator').textContent = 'Sale Ended';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('balance').textContent = 'Connection error';
            }
        }

        function updateCountdown() {
            countdownValue--;
            document.getElementById('refresh-countdown').textContent = countdownValue;

            if (countdownValue <= 0) {
                countdownValue = refreshInterval;
                fetchData();
            }
        }

        // Initial load
        loadConfig();
        fetchData();

        // Auto-refresh
        setInterval(updateCountdown, 1000);

        // Close config panel on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const panel = document.getElementById('config-panel');
                if (panel.classList.contains('active')) {
                    toggleConfig();
                }
            }
        });

        // Close config panel when clicking outside
        document.getElementById('config-panel').addEventListener('click', (e) => {
            if (e.target.id === 'config-panel') {
                toggleConfig();
            }
        });
    </script>
</body>
</html>
